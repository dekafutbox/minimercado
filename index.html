<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d6efd">
    <title>Conta Fiada App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --app-height: 100vh; }
        body { 
            background-color: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px; /* Espa√ßo para o menu inferior */
            overscroll-behavior-y: none; /* Evita o efeito el√°stico no topo/fundo */
        }
        
        /* HEADER FIXO */
        .app-header {
            position: sticky; top: 0; z-index: 1000;
            background: #0d6efd; color: white;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        /* MENU INFERIOR (BOTTOM NAV) */
        .mobile-bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex; justify-content: space-around;
            padding: 10px 0;
            z-index: 1050;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-icon-btn {
            background: none; border: none; color: #6c757d;
            display: flex; flex-direction: column; align-items: center;
            font-size: 12px; flex: 1;
        }
        .nav-icon-btn i { font-size: 24px; margin-bottom: 2px; }
        .nav-icon-btn.active { color: #0d6efd; font-weight: bold; }

        /* CARDS GERAIS */
        .card-custom {
            border: none; border-radius: 12px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 12px;
        }

        /* PRODUTOS NA VENDA (GRID) */
        .product-grid-container {
            max-height: 40vh; /* Altura fixa para scroll */
            overflow-y: auto;
            padding: 5px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        .product-item-card {
            background: white; border: 1px solid #eee;
            border-radius: 10px; padding: 10px;
            text-align: center; height: 100%;
            transition: 0.1s;
        }
        .product-item-card:active { transform: scale(0.95); background-color: #f8f9fa; }
        
        /* LISTA DE CLIENTES E ESTOQUE (CARDS EM VEZ DE TABELA) */
        .list-card {
            background: white; padding: 15px;
            border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 4px solid transparent;
        }
        .list-card.highlight { border-left-color: #0d6efd; background-color: #f8fbff; }
        
        /* UTILIT√ÅRIOS */
        .display-change { color: #198754; font-weight: bold; font-size: 1.1rem; }
        .display-debt { color: #dc3545; font-weight: bold; font-size: 1.1rem; }
        #reader, #readerCart { border-radius: 12px; overflow: hidden; border: 2px solid #0d6efd; display: none; margin-bottom: 10px; }
        
        /* Inputs grandes para dedo */
        .form-control-lg { font-size: 1.1rem; padding: 12px; }
        .btn-lg { padding: 12px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="app-header d-flex justify-content-between align-items-center">
    <h5 class="m-0 fw-bold"><i class="bi bi-wallet2"></i> Conta Fiada</h5>
    <button onclick="resetSystem()" class="btn btn-sm btn-light text-danger fw-bold" style="border-radius: 20px;">Zerar</button>
</div>

<div class="container mt-3">
    <div class="tab-content" id="mainTabContent">
        
        <div class="tab-pane fade show active" id="tab-venda">
            
            <div class="card-custom p-3">
                <input type="text" id="searchProduct" class="form-control mb-2" placeholder="üîç Buscar produto..." onkeyup="renderPOSProducts()">
                <div id="posProductList" class="product-grid-container row g-2"></div>
            </div>

            <div class="card-custom p-3 border-top border-3 border-primary">
                <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse" data-bs-target="#cartDetails" aria-expanded="false">
                    <h6 class="m-0 fw-bold text-primary"><i class="bi bi-cart"></i> Carrinho (<span id="cartCount">0</span>)</h6>
                    <i class="bi bi-chevron-down text-muted"></i>
                </div>
                
                <div class="collapse" id="cartDetails">
                    <div class="table-responsive mb-2" style="max-height: 150px;">
                        <table class="table table-sm table-borderless small m-0">
                            <tbody id="cartTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-3">
                    <span class="text-muted small">Total a Pagar</span>
                    <span id="cartTotalDisplay" class="fs-4 fw-bold text-dark">R$ 0,00</span>
                </div>
                <div id="feeRow" class="text-end text-danger small mb-2" style="display:none; line-height:1;">
                    <span id="feeLabel">Taxa:</span> <span id="feeDisplay">R$ 0,00</span>
                </div>

                <label class="form-label small text-muted text-uppercase fw-bold">1. Cliente</label>
                <div class="input-group mb-2">
                    <button class="btn btn-outline-primary" onclick="startScanner('cart')"><i class="bi bi-qr-code"></i></button>
                    <input type="text" id="customerSearchInput" class="form-control" placeholder="Buscar Cliente..." onkeyup="filterCartCustomers()">
                </div>
                <div id="readerCart"></div>
                <select class="form-select mb-3" id="saleCustomer" onchange="syncSearchInput()"></select>

                <label class="form-label small text-muted text-uppercase fw-bold">2. Pagamento</label>
                <select class="form-select mb-3" id="paymentMethod" onchange="updateTotalWithFees()">
                    <option value="Dinheiro">üíµ Dinheiro</option>
                    <option value="Pix">üí† Pix</option>
                    <option value="Cart√£o de Cr√©dito">üí≥ Cr√©dito</option>
                    <option value="Cart√£o de D√©bito">üí≥ D√©bito</option>
                    <option value="Fiado">üìí Fiado</option>
                </select>

                <label class="form-label small text-muted text-uppercase fw-bold">3. Valor Recebido</label>
                <input type="number" step="0.01" class="form-control form-control-lg fw-bold mb-3" id="amountPaid" placeholder="R$ 0,00" onkeyup="calcChange()">

                <div id="balanceResult" class="text-center p-2 rounded mb-3 bg-light border" style="display:none;">
                    <div id="changeLabel" class="small text-muted">Troco</div>
                    <div id="changeValue">R$ 0,00</div>
                </div>
                
                <button id="btnShowPix" class="btn btn-info w-100 mb-2" style="display:none;" data-bs-toggle="modal" data-bs-target="#pixModal">Ver Pix</button>
                <button onclick="finalizeSale()" class="btn btn-primary w-100 btn-lg fw-bold shadow-sm">FINALIZAR</button>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-clientes">
            <div class="card-custom p-3" id="newClientCard" style="display:none;">
                <h6 class="fw-bold mb-3">Novo Cadastro</h6>
                <div id="reader"></div>
                <input type="text" id="newClientName" class="form-control mb-2" placeholder="Nome Completo">
                <div class="input-group mb-2">
                    <input type="text" id="newClientPhone" class="form-control" placeholder="WhatsApp (Opcional)">
                    <button class="btn btn-outline-dark" onclick="startScanner('manual')"><i class="bi bi-qr-code"></i></button>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="addCustomer()" class="btn btn-success flex-grow-1">Salvar</button>
                    <button onclick="toggleNewClient()" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>

            <div class="d-flex gap-2 mb-3">
                <input type="text" id="searchClient" class="form-control shadow-sm" placeholder="üîç Buscar cliente..." onkeyup="renderCustomers()">
                <button class="btn btn-primary shadow-sm" onclick="toggleNewClient()"><i class="bi bi-person-plus"></i></button>
                <div class="dropdown">
                    <button class="btn btn-light shadow-sm" type="button" data-bs-toggle="dropdown"><i class="bi bi-funnel"></i></button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" onclick="setBalanceFilter('all')">Todos</a></li>
                        <li><a class="dropdown-item" onclick="setBalanceFilter('negative')">Devedores</a></li>
                        <li><a class="dropdown-item" onclick="setBalanceFilter('positive')">Cr√©ditos</a></li>
                    </ul>
                </div>
            </div>

            <div id="customerListContainer"></div>
            
            <button onclick="document.getElementById('excelInput').click()" class="btn btn-outline-success btn-sm w-100 mt-3 mb-5">Importar Excel</button>
            <input type="file" id="excelInput" style="display:none" onchange="importCustomers(this)">
        </div>

        <div class="tab-pane fade" id="tab-estoque">
            <div class="card-custom p-3 mb-3">
                <h6 class="fw-bold">Adicionar Item</h6>
                <div class="row g-2">
                    <div class="col-12"><input type="text" id="prodName" class="form-control" placeholder="Nome do Produto"></div>
                    <div class="col-6"><input type="number" id="prodPrice" class="form-control" placeholder="Pre√ßo"></div>
                    <div class="col-6"><input type="number" id="prodStock" class="form-control" placeholder="Qtd"></div>
                    <div class="col-12"><button onclick="addProduct()" class="btn btn-primary w-100">Adicionar ao Estoque</button></div>
                </div>
            </div>
            
            <h6 class="text-muted ms-2 mb-2 small">LISTA DE PRODUTOS</h6>
            <div id="inventoryListContainer"></div>
            
            <button onclick="document.getElementById('prodExcelInput').click()" class="btn btn-outline-success btn-sm w-100 mt-3 mb-5">Importar Excel</button>
            <input type="file" id="prodExcelInput" style="display:none" onchange="importProducts(this)">
        </div>

        <div class="tab-pane fade" id="tab-config">
            <div class="card-custom p-3">
                <h6 class="fw-bold border-bottom pb-2">Taxas</h6>
                <label class="small">Cr√©dito (%)</label>
                <input type="number" id="cardFee" class="form-control mb-2">
                <label class="small">D√©bito (R$ Fixo)</label>
                <input type="number" id="debitFee" class="form-control mb-3">
                
                <h6 class="fw-bold border-bottom pb-2 mt-4">Pix</h6>
                <label class="small">QR Code (Imagem)</label>
                <input type="file" id="pixUpload" class="form-control mb-2" onchange="previewPix(this)">
                <img id="pixDisplayImg" src="" style="display:none; width: 100px; border-radius: 8px; margin-bottom: 10px;">
                
                <h6 class="fw-bold border-bottom pb-2 mt-4">Link Externo</h6>
                <input type="text" id="externalLink" class="form-control mb-2" placeholder="https://...">
                <a id="btnExternalLink" href="#" target="_blank" class="btn btn-outline-primary w-100 mb-3 disabled">Acessar App Externo</a>

                <button onclick="saveConfigs()" class="btn btn-primary w-100 py-3">Salvar Tudo</button>
            </div>
        </div>

    </div>
</div>

<nav class="mobile-bottom-nav">
    <button class="nav-icon-btn active" onclick="switchTab('tab-venda', this)">
        <i class="bi bi-cart4"></i> Venda
    </button>
    <button class="nav-icon-btn" onclick="switchTab('tab-clientes', this)">
        <i class="bi bi-people-fill"></i> Clientes
    </button>
    <button class="nav-icon-btn" onclick="switchTab('tab-estoque', this)">
        <i class="bi bi-box-seam"></i> Estoque
    </button>
    <button class="nav-icon-btn" onclick="switchTab('tab-config', this)">
        <i class="bi bi-gear-fill"></i> Config
    </button>
</nav>

<div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5>Hist√≥rico</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="historyList"></div></div></div></div>
<div class="modal fade" id="pixModal" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content text-center p-4"><h5>Pix</h5><img id="pixModalImg" src="" class="img-fluid my-3 rounded"><button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- L√ìGICA DO SISTEMA ---
    let products = JSON.parse(localStorage.getItem('cf_products')) || [];
    let customers = JSON.parse(localStorage.getItem('cf_customers')) || [];
    let config = JSON.parse(localStorage.getItem('cf_config')) || { cardFee: 0, debitFee: 0, pixImg: '', externalLink: '' };
    let cart = [];
    let balanceFilter = 'all';

    // Navega√ß√£o Mobile Simples
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('show', 'active'));
        document.getElementById(tabId).classList.add('show', 'active');
        document.querySelectorAll('.nav-icon-btn').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
    }

    function toggleNewClient() {
        const card = document.getElementById('newClientCard');
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
    }

    function init() {
        if(config.pixImg) { document.getElementById('pixDisplayImg').src = config.pixImg; document.getElementById('pixDisplayImg').style.display = 'block'; document.getElementById('pixModalImg').src = config.pixImg; }
        document.getElementById('cardFee').value = config.cardFee || 0;
        document.getElementById('debitFee').value = config.debitFee || 0;
        
        const linkBtn = document.getElementById('btnExternalLink');
        document.getElementById('externalLink').value = config.externalLink || '';
        if (config.externalLink) { linkBtn.href = config.externalLink; linkBtn.classList.remove('disabled'); linkBtn.classList.add('btn-primary'); }

        renderProducts(); renderCustomers(); renderPOSProducts(); updateCustomerSelect();
    }

    function saveData() {
        localStorage.setItem('cf_products', JSON.stringify(products));
        localStorage.setItem('cf_customers', JSON.stringify(customers));
        localStorage.setItem('cf_config', JSON.stringify(config));
    }

    // --- RENDERIZA√á√ÉO MOBILE ---
    
    // 1. Clientes como Cards
    function renderCustomers() {
        const search = document.getElementById('searchClient').value.toLowerCase();
        let filtered = customers.filter(c => c.name.toLowerCase().includes(search));
        if (balanceFilter === 'negative') filtered = filtered.filter(c => c.balance < 0);
        if (balanceFilter === 'positive') filtered = filtered.filter(c => c.balance > 0);

        filtered.sort((a, b) => {
            const aActive = a.history.some(h => h.type === 'Compra');
            const bActive = b.history.some(h => h.type === 'Compra');
            if (aActive && !bActive) return -1;
            if (!aActive && bActive) return 1;
            return a.name.localeCompare(b.name);
        });

        const container = document.getElementById('customerListContainer');
        container.innerHTML = filtered.map(c => {
            const active = c.history.some(h => h.type === 'Compra');
            const balanceColor = c.balance >= 0 ? 'text-success' : 'text-danger';
            return `
            <div class="list-card ${active ? 'highlight' : ''}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <div class="fw-bold text-dark fs-6">${c.name}</div>
                        <div class="text-muted small"><i class="bi bi-whatsapp"></i> ${c.phone || '-'}</div>
                    </div>
                    <div class="text-end">
                        <div class="${balanceColor} fw-bold fs-5">R$ ${c.balance.toFixed(2)}</div>
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-light flex-grow-1 text-primary" onclick="viewHist(${c.id})"><i class="bi bi-clock-history"></i> Hist√≥rico</button>
                    <button class="btn btn-sm btn-light flex-grow-1 text-success" onclick="payDebt(${c.id})"><i class="bi bi-cash"></i> Pagar</button>
                    <button class="btn btn-sm btn-light text-danger" onclick="delCust(${c.id})"><i class="bi bi-trash"></i></button>
                </div>
            </div>`;
        }).join('');
    }

    // 2. Estoque como Cards
    function renderProducts() {
        const container = document.getElementById('inventoryListContainer');
        container.innerHTML = products.map((p, i) => `
            <div class="list-card d-flex justify-content-between align-items-center py-2">
                <div>
                    <div class="fw-bold">${p.name}</div>
                    <div class="text-muted small">R$ ${p.price.toFixed(2)} | Estoque: ${p.stock}</div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-light text-warning" onclick="editProd(${i})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-light text-danger" onclick="delProd(${i})"><i class="bi bi-trash"></i></button>
                </div>
            </div>`).join('');
    }

    // 3. Produtos na Venda (Grid Mobile)
    function renderPOSProducts() {
        const s = document.getElementById('searchProduct').value.toLowerCase();
        document.getElementById('posProductList').innerHTML = products.filter(p => p.name.toLowerCase().includes(s)).map(p => `
            <div class="col-4 col-sm-3">
                <div class="product-item-card d-flex flex-column justify-content-between" onclick="addCart(${p.id})">
                    <div class="small fw-bold text-truncate w-100" title="${p.name}">${p.name}</div>
                    <div class="text-success fw-bold small mt-1">R$${p.price.toFixed(2)}</div>
                    <small class="text-muted" style="font-size: 10px;">Restam: ${p.stock}</small>
                </div>
            </div>`).join('');
    }

    // --- FUN√á√ïES DE VENDAS (L√ìGICA V14) ---
    function calcChange() {
        const total = updateTotalWithFees();
        const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
        const display = document.getElementById('balanceResult');
        const label = document.getElementById('changeLabel');
        const value = document.getElementById('changeValue');

        if (paid === 0 && document.getElementById('paymentMethod').value !== 'Fiado') {
            display.style.display = 'none'; return;
        }
        display.style.display = 'block';
        const diff = paid - total;

        if (diff >= 0) {
            label.innerText = "Troco / Cr√©dito"; value.innerText = `R$ ${diff.toFixed(2)}`; value.className = "display-change";
        } else {
            label.innerText = "Faltando (Vai para Saldo)"; value.innerText = `R$ ${Math.abs(diff).toFixed(2)}`; value.className = "display-debt";
        }
    }

    function updateTotalWithFees() {
        const method = document.getElementById('paymentMethod').value;
        const totalBase = cart.reduce((a, b) => a + (b.price * b.qty), 0);
        let final = totalBase;
        let fee = 0;
        
        document.getElementById('btnShowPix').style.display = (method === 'Pix') ? 'block' : 'none';

        if (method === 'Cart√£o de Cr√©dito' && config.cardFee > 0) {
            fee = totalBase * (config.cardFee / 100); final += fee;
            document.getElementById('feeRow').style.display = 'block';
            document.getElementById('feeLabel').innerText = `Taxa (${config.cardFee}%)`;
            document.getElementById('feeDisplay').innerText = `+ R$ ${fee.toFixed(2)}`;
        } else if (method === 'Cart√£o de D√©bito' && config.debitFee > 0) {
            fee = parseFloat(config.debitFee); final += fee;
            document.getElementById('feeRow').style.display = 'block';
            document.getElementById('feeLabel').innerText = `Taxa D√©bito`;
            document.getElementById('feeDisplay').innerText = `+ R$ ${fee.toFixed(2)}`;
        } else {
            document.getElementById('feeRow').style.display = 'none';
        }

        document.getElementById('cartTotalDisplay').innerText = `R$ ${final.toFixed(2)}`;
        return final;
    }

    function finalizeSale() {
        const total = updateTotalWithFees();
        const cid = document.getElementById('saleCustomer').value;
        const paid = parseFloat(document.getElementById('amountPaid').value) || 0;
        if (!cart.length || !cid) return alert("Selecione produtos e cliente");

        const cust = customers.find(c => c.id == cid);
        const method = document.getElementById('paymentMethod').value;
        const items = cart.map(i => `${i.qty}x ${i.name}`).join(', ');

        cust.history.push({ date: new Date().toLocaleString(), type: 'Compra', items, method, value: -total });
        if (paid > 0) cust.history.push({ date: new Date().toLocaleString(), type: 'Pagamento Venda', method, value: paid });
        
        cust.balance += (paid - total);
        cart.forEach(c => { const p = products.find(x => x.id === c.id); if(p) p.stock -= c.qty; });

        cart = []; document.getElementById('amountPaid').value = ''; 
        document.getElementById('balanceResult').style.display = 'none';
        document.getElementById('customerSearchInput').value = '';
        saveData(); renderPOSProducts(); renderCustomers(); updateCustomerSelect();
        renderCart(); // Limpa visual do carrinho
        alert(`Venda OK!\nNovo Saldo: R$ ${cust.balance.toFixed(2)}`);
    }

    // --- CARRINHO ---
    function addCart(id) {
        const p = products.find(i => i.id === id);
        if(p.stock <= 0) return alert("Sem estoque");
        const item = cart.find(i => i.id === id);
        if(item) { if(item.qty < p.stock) item.qty++; } else cart.push({...p, qty: 1});
        renderCart();
    }

    function renderCart() {
        document.getElementById('cartTableBody').innerHTML = cart.map((i, idx) => `
            <tr><td>${i.name}</td><td>${i.qty}x</td><td class="text-end">R$${(i.price*i.qty).toFixed(2)} <i class="bi bi-x text-danger ms-2" onclick="remCart(${idx})"></i></td></tr>`).join('');
        updateTotalWithFees(); calcChange();
        document.getElementById('cartCount').innerText = cart.length;
    }
    function remCart(i) { cart.splice(i, 1); renderCart(); }

    // --- GEST√ÉO GERAL ---
    function addProduct() {
        const name = document.getElementById('prodName').value;
        const price = parseFloat(document.getElementById('prodPrice').value);
        if(!name || isNaN(price)) return;
        products.push({id: Date.now(), name, price, stock: parseInt(document.getElementById('prodStock').value)||0});
        saveData(); renderProducts(); renderPOSProducts();
        document.getElementById('prodName').value = ''; document.getElementById('prodPrice').value = '';
    }
    function editProd(i) {
        const p = products[i];
        const n = prompt("Nome:", p.name); const v = prompt("Pre√ßo:", p.price); const e = prompt("Estoque:", p.stock);
        if(n) p.name = n; if(v) p.price = parseFloat(v); if(e) p.stock = parseInt(e);
        saveData(); renderProducts(); renderPOSProducts();
    }
    function addCustomer(fromName = null) {
        const name = fromName || document.getElementById('newClientName').value;
        if(!name) return;
        const newCust = {id: Date.now(), name, phone: document.getElementById('newClientPhone').value||'', balance: 0, history: []};
        customers.push(newCust); saveData(); renderCustomers(); updateCustomerSelect();
        toggleNewClient();
        return newCust;
    }
    function payDebt(id) {
        const c = customers.find(x => x.id === id);
        const v = prompt("Valor pago:");
        if(v) { c.balance += parseFloat(v.replace(',','.')); c.history.push({date: new Date().toLocaleString(), type: 'Pagamento D√≠vida', value: parseFloat(v)}); saveData(); renderCustomers(); }
    }
    function viewHist(id) {
        const c = customers.find(x => x.id === id);
        document.getElementById('historyList').innerHTML = c.history.slice().reverse().map(h => `
            <div class="hist-item ${h.value < 0 ? 'hist-buy' : 'hist-pay'} small">
                <div class="d-flex justify-content-between"><b>${h.date}</b> <span>R$ ${Math.abs(h.value).toFixed(2)}</span></div>
                <div>${h.type} (${h.method || '-'})</div>
                <div class="text-muted">${h.items || ''}</div>
            </div>`).join('');
        new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    // Auxiliares
    function filterCartCustomers() {
        const input = document.getElementById('customerSearchInput').value.toLowerCase();
        const select = document.getElementById('saleCustomer');
        select.innerHTML = '<option value="">Resultados...</option>' + customers.filter(c => c.name.toLowerCase().includes(input)).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
    function syncSearchInput() {
        const select = document.getElementById('saleCustomer');
        if(select.value !== "") document.getElementById('customerSearchInput').value = select.options[select.selectedIndex].text;
    }
    function updateCustomerSelect() { document.getElementById('saleCustomer').innerHTML = '<option value="">Selecionar...</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); }
    function setBalanceFilter(t) { balanceFilter = t; renderCustomers(); }
    function delCust(id) { if(confirm("Apagar?")) { customers = customers.filter(c => c.id !== id); saveData(); renderCustomers(); updateCustomerSelect(); } }
    function delProd(i) { products.splice(i, 1); saveData(); renderProducts(); renderPOSProducts(); }
    
    // Configs, Scanner e Import
    function saveConfigs() {
        config.cardFee = parseFloat(document.getElementById('cardFee').value)||0;
        config.debitFee = parseFloat(document.getElementById('debitFee').value)||0;
        config.externalLink = document.getElementById('externalLink').value;
        saveData(); init(); alert("Salvo!");
    }
    function previewPix(input) { const reader = new FileReader(); reader.onload = (e) => { config.pixImg = e.target.result; init(); saveData(); }; reader.readAsDataURL(input.files[0]); }
    function startScanner(type) {
        const cont = type === 'manual' ? 'reader' : 'readerCart';
        document.getElementById(cont).style.display = 'block';
        const scanner = new Html5Qrcode(cont);
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            if(type === 'manual') document.getElementById('newClientName').value = txt;
            else { const n = addCustomer(txt); document.getElementById('saleCustomer').value = n.id; document.getElementById('customerSearchInput').value = n.name; }
            scanner.stop(); document.getElementById(cont).style.display = 'none';
        });
    }
    function importCustomers(input) { const reader = new FileReader(); reader.onload = (e) => { const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); json.forEach(row => { const n = row['Nome']||row['nome']; if(n) customers.push({id: Date.now()+Math.random(), name: n, phone: row['Telefone']||'', balance: 0, history: []}); }); saveData(); renderCustomers(); updateCustomerSelect(); alert("Ok"); }; reader.readAsArrayBuffer(input.files[0]); }
    function importProducts(input) { const reader = new FileReader(); reader.onload = (e) => { const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); json.forEach(row => { const n = row['Nome']||row['nome']; const p = parseFloat(row['Pre√ßo']||0); if(n) products.push({id: Date.now()+Math.random(), name: n, price: p, stock: parseInt(row['Estoque']||0)}); }); saveData(); renderProducts(); renderPOSProducts(); alert("Ok"); }; reader.readAsArrayBuffer(input.files[0]); }
    function resetSystem() { if(confirm("Apagar tudo?")) { localStorage.clear(); location.reload(); } }

    init();
</script>
</body>
</html>
